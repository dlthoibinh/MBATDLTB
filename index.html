<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>EVN-SPC | MBA Tracker (PRO)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{ --brand:#0ea5e9; --text:#0f172a; --muted:#64748b; --ok:#16a34a; --bad:#ef4444; --bg:#f6f8fb; --card:#fff; --ring:rgba(14,165,233,.35); }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;background:var(--bg);z-index:50;border-bottom:1px solid #e5e7eb}
    .brand{display:flex;align-items:center;gap:10px;padding:10px 12px}
    .dot{width:10px;height:10px;border-radius:9999px;background:var(--brand)}
    .brand h1{margin:0;font-size:16px;font-weight:800}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    nav{display:flex;gap:8px;padding:0 12px 10px;flex-wrap:wrap}
    nav button{border:1px solid #cbd5e1;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.04);padding:12px;margin:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:760px){ .row,.row3{grid-template-columns:1fr} .wrap{padding:8px} }
    label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;outline:none}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring);border-color:var(--brand)}
    .btn{border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#0b6aa2}
    .btn.ghost{background:#fff;border:1px solid #cbd5e1;color:#0f172a}
    .danger{background:var(--bad)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;font-size:14px;text-align:left}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .kpi .card{margin:0;padding:10px;text-align:center}
    .kpi .num{font-weight:800;font-size:18px}
    .footer{padding:40px 12px;color:var(--muted);text-align:center}
    .warn{color:#d97706}.ok{color:var(--ok)}.bad{color:#ef4444}
    .install{position:fixed;bottom:12px;left:12px;right:12px;background:#fff;padding:10px;border:1px solid #cbd5e1;border-radius:12px;display:none}
    #qr_overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
    #qr_box{background:#000;border-radius:12px;padding:8px}
    #qr_video{width:min(96vw,520px);height:auto;border-radius:10px}
    #map{height:220px;border-radius:12px;border:1px solid #e5e7eb}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <h1>EVN-SPC | MBA Tracker PRO</h1>
        <span class="right muted" id="usr">Đang tải người dùng…</span>
      </div>
      <nav>
        <button class="active" data-tab="tab-input">Nhập liệu</button>
        <button data-tab="tab-history">Lịch sử</button>
        <button data-tab="tab-stats">Thống kê</button>
        <button data-tab="tab-report">Báo cáo</button>
      </nav>
    </header>

    <!-- Nhập liệu -->
    <section id="tab-input" class="card">
      <div class="row">
        <div>
          <label>Máy biến áp</label>
          <div class="row">
            <div><input id="f_q" placeholder="Tìm mã/tên/khu vực…"></div>
            <div class="right" style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn ghost" id="btn_qr" title="Quét QR MBA">QR</button>
              <button class="btn ghost" id="btn_reload">Tải DS</button>
            </div>
          </div>
          <div class="muted" id="f_pick_info"></div>
          <div id="f_list" class="card" style="max-height:240px;overflow:auto"></div>
        </div>
        <div>
          <div class="row">
            <div><label>Điện áp V (kV)</label><input id="f_V" type="number" step="0.01"></div>
            <div><label>Dòng I (A)</label><input id="f_I" type="number" step="0.1"></div>
          </div>
          <div class="row">
            <div><label>Công suất P (kW)</label><input id="f_P" type="number" step="0.1"></div>
            <div><label>Nhiệt độ cuộn (°C)</label><input id="f_temp" type="number" step="0.1"></div>
          </div>
          <div class="row">
            <div><label>Nhiệt độ dầu (°C)</label><input id="f_oil" type="number" step="0.1"></div>
            <div><label>Vị trí nấc (tap)</label><input id="f_tap" type="text" placeholder="1..n"></div>
          </div>
          <div class="row">
            <div><label>Tải (%)</label><input id="f_load" type="number" step="0.1"></div>
            <div>
              <label>Trạng thái</label>
              <select id="f_status"><option>OK</option><option>WARNING</option><option>ALARM</option></select>
            </div>
          </div>
          <label>Ghi chú</label><textarea id="f_note" rows="2" placeholder="Ghi chú hiện trường…"></textarea>
          <div class="row">
            <div class="row">
              <div><label>Ảnh (tuỳ chọn)</label><input id="f_photo" type="file" accept="image/*" capture="environment"></div>
            </div>
            <div class="row">
              <div><label>Vị trí</label>
                <div style="display:flex;gap:8px">
                  <button class="btn secondary" id="btn_loc">Lấy vị trí</button>
                  <span class="muted" id="loc_info"></span>
                </div>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button class="btn" id="btn_submit">Lưu</button>
            <span class="muted" id="queue_info"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Lịch sử -->
    <section id="tab-history" class="card" hidden>
      <div style="display:flex;gap:8px;align-items:center">
        <h3 style="margin:0">Lịch sử</h3>
        <div class="right"></div>
        <input id="h_id" placeholder="Mã MBA (tuỳ chọn)" style="max-width:180px">
        <input id="h_from" type="date"><input id="h_to" type="date">
        <button class="btn" id="btn_history">Tải</button>
        <button class="btn ghost" id="btn_export">Export CSV</button>
      </div>
      <div style="overflow:auto">
        <table id="hist_tbl">
          <thead><tr>
            <th>Thời gian</th><th>MBA</th><th>P(kW)</th><th>T(°C)</th><th>Oil(°C)</th><th>Tải%</th><th>TT</th><th>Ghi chú</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Thống kê -->
    <section id="tab-stats" class="card" hidden>
      <div style="display:flex;gap:8px;align-items:center">
        <h3 style="margin:0">Thống kê</h3>
        <div class="right"></div>
        <input id="s_id" placeholder="Mã MBA (tuỳ chọn)" style="max-width:180px">
        <input id="s_from" type="date"><input id="s_to" type="date">
        <button class="btn" id="btn_stats">Phân tích</button>
      </div>
      <div class="kpi" style="margin-top:8px">
        <div class="card"><div class="muted">Bản ghi</div><div class="num" id="k_count">0</div></div>
        <div class="card"><div class="muted">Avg Temp</div><div class="num" id="k_avgT">0</div></div>
        <div class="card"><div class="muted">Avg Oil</div><div class="num" id="k_avgO">0</div></div>
        <div class="card"><div class="muted">Avg Load%</div><div class="num" id="k_avgL">0</div></div>
        <div class="card"><div class="muted">Max Load%</div><div class="num" id="k_maxL">0</div></div>
      </div>
      <div class="card"><canvas id="chart1" height="160"></canvas></div>
      <div class="card"><canvas id="chart2" height="160"></canvas></div>
      <div class="card">
        <h4 style="margin:6px 0">Bất thường gần đây</h4>
        <ul id="anom" style="margin:0 0 6px 18px"></ul>
      </div>
    </section>

    <!-- Báo cáo -->
    <section id="tab-report" class="card" hidden>
      <h3 style="margin-top:0">Báo cáo sự cố/điểm bất thường</h3>
      <div class="row">
        <div>
          <label>Mã MBA</label><input id="r_id" placeholder="VD: MBA001">
          <label>Loại sự cố</label><input id="r_type" placeholder="rò rỉ dầu / quá nhiệt / tiếng ồn…">
          <label>Mức độ</label>
          <select id="r_sev"><option>minor</option><option>major</option><option>critical</option></select>
          <label>Ảnh (tuỳ chọn)</label><input id="r_photo" type="file" accept="image/*" capture="environment">
        </div>
        <div>
          <label>Nội dung</label><textarea id="r_msg" rows="6" placeholder="Mô tả chi tiết…"></textarea>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button class="btn secondary" id="r_loc">Vị trí</button>
            <span class="muted" id="r_locinfo"></span>
            <div class="right"></div>
            <button class="btn danger" id="btn_report">Gửi báo cáo</button>
          </div>
          <div id="map_wrap" style="margin-top:8px;display:none">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </section>

    <div class="install" id="installBox">
      <div style="display:flex;gap:8px;align-items:center">
        <div><b>Cài đặt PWA</b> để dùng nhanh hơn</div>
        <div class="right"></div>
        <button class="btn" id="btn_install">Cài đặt</button>
        <button class="btn secondary" id="btn_install_close">Đóng</button>
      </div>
    </div>

    <!-- QR Overlay -->
    <div id="qr_overlay">
      <div id="qr_box"><video id="qr_video" autoplay playsinline></video></div>
    </div>

    <div class="footer">EVN-SPC · MBA Tracker PRO · v1.1</div>
  </div>

  <script>
    /* ==== CONFIG: Dán URL exec của Apps Script vào đây ==== */
    const BASE = "https://script.google.com/macros/s/AKfycbyTRo8I5pMxVGyyRbA1rByGNNjQ2TxI5U9PJwPkqcldurmphAwpEx8jMwsNrSJW7l8z/exec";

    const st = { pick:null, loc:null, me:null, cfg:null, deferredPrompt:null, mediaStream:null, map:null };
    document.querySelectorAll('nav button').forEach(b=>b.onclick=()=>{ document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); const tab=b.getAttribute('data-tab'); document.querySelectorAll('section.card').forEach(s=>s.hidden=(s.id!==tab)); });

    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); st.deferredPrompt=e; document.getElementById('installBox').style.display='block'; });
    document.getElementById('btn_install').onclick = async ()=>{ if(!st.deferredPrompt) return; st.deferredPrompt.prompt(); st.deferredPrompt=null; document.getElementById('installBox').style.display='none'; };
    document.getElementById('btn_install_close').onclick = ()=>{ document.getElementById('installBox').style.display='none'; };

    function setUser(u){ const el=document.getElementById('usr'); el.textContent=`${u.email||'anonymous'} · ${u.role||'guest'} · ${navigator.onLine?'Online':'Offline'}`; }
    window.addEventListener('online', flushQueue); window.addEventListener('offline', ()=>{ if(st.me) setUser(st.me); });

    /* --- API helpers: GET/POST không preflight --- */
    async function apiGet(fn, params = {}) {
      const qs = new URLSearchParams(Object.assign({ p:'api', fn }, params));
      const r = await fetch(BASE + '?' + qs.toString(), { method:'GET' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json(); if (!j.ok) throw new Error(j.error||'API error'); return j.data;
    }
    async function apiPost(action, data = {}) {
      const form = new URLSearchParams(); form.set('p','api'); form.set('action',action); form.set('payload', JSON.stringify(data));
      const r = await fetch(BASE, { method:'POST', body: form });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json(); if (!j.ok) throw new Error(j.error||'API error'); return j.data;
    }

    function guardRole(){ if(!st.me) return; const canWrite=["admin","lanhdao","leader","totruong","trucban","nhanvien"].includes(st.me.role) || String(st.me.cfg.AUTH_OPEN||"0")==="1"; document.getElementById('btn_submit').disabled=!canWrite; document.getElementById('btn_report').disabled=!canWrite; }

    /* Danh sách MBA */
    const el_q = document.getElementById('f_q'), el_list=document.getElementById('f_list'), el_info=document.getElementById('f_pick_info');
    async function reloadList(){
      const q = el_q.value.trim();
      const data = await apiGet("list_transformers",{q});
      el_list.innerHTML = data.map(r=>`<div class="row" style="padding:8px;border-bottom:1px solid #eee;cursor:pointer" data-id="${r.id}" data-name="${r.name}"><div><b>${r.id}</b> — ${r.name}<div class="muted" style="font-size:12px">${r.location||""}</div></div><div style="text-align:right">${r.rated_kVA||""} kVA</div></div>`).join("");
      el_list.querySelectorAll('[data-id]').forEach(d=>d.onclick=()=>{ st.pick={id:d.dataset.id, name:d.dataset.name}; el_info.textContent=`Đã chọn: ${st.pick.id} — ${st.pick.name}`; });
    }
    el_q.addEventListener('input', debounce(reloadList, 200));
    document.getElementById('btn_reload').onclick = reloadList;

    /* Vị trí + map */
    document.getElementById('btn_loc').onclick = ()=>getLocation('loc_info');
    document.getElementById('r_loc').onclick  = ()=>getLocation('r_locinfo');
    async function getLocation(infoId){
      try{
        const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res, rej, {enableHighAccuracy:true,timeout:10000}));
        st.loc = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        document.getElementById(infoId).textContent = `${st.loc.lat.toFixed(6)}, ${st.loc.lng.toFixed(6)}`;
        if (Number(st.cfg.FEATURE_MAP||1)) showMap(st.loc);
      }catch(e){ alert("Không lấy được vị trí: "+e.message); }
    }
    function ensureLeaflet(){ return new Promise((res)=>{ if (window.L){res();return;} const link=document.createElement('link'); link.rel='stylesheet'; link.href='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'; const script=document.createElement('script'); script.src='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'; script.onload=()=>res(); document.head.appendChild(link); document.body.appendChild(script); }); }
    async function showMap(ll){ document.getElementById('map_wrap').style.display='block'; await ensureLeaflet(); if (!st.map){ st.map=L.map('map').setView([ll.lat, ll.lng], 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(st.map); st.map.marker=L.marker([ll.lat, ll.lng]).addTo(st.map); } else { st.map.setView([ll.lat, ll.lng], st.map.getZoom()); st.map.marker.setLatLng([ll.lat, ll.lng]); } }

    /* QR (BarcodeDetector) */
    const ov=document.getElementById('qr_overlay'), v=document.getElementById('qr_video');
    document.getElementById('btn_qr').onclick = async ()=>{
      if (!Number(st.cfg.FEATURE_QR||1)) { alert("Tính năng QR đang tắt."); return; }
      if (!('BarcodeDetector' in window)) { alert("Thiết bị không hỗ trợ BarcodeDetector."); return; }
      try{
        const det=new BarcodeDetector({formats:['qr_code','code_128','code_39']});
        st.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); v.srcObject=st.mediaStream; ov.style.display='flex';
        const tick=async()=>{ if (ov.style.display==='none') return; try{ const caps=await det.detect(v); if (caps && caps.length){ const txt=caps[0].rawValue||""; ov.style.display='none'; stopMedia(); el_q.value=txt; await reloadList(); const pick=Array.from(el_list.querySelectorAll('[data-id]')).find(d=>d.dataset.id===txt); if (pick){ pick.click(); } return; } }catch(e){} requestAnimationFrame(tick); }; requestAnimationFrame(tick); ov.onclick=()=>{ ov.style.display='none'; stopMedia(); };
      }catch(e){ alert("Không mở được camera: "+e.message); }
    };
    function stopMedia(){ try{ st.mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){} }

    /* File → dataURL */
    async function fileToDataURL(input){ const f=input.files && input.files[0]; if(!f) return ""; return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

    /* Offline queue */
    const QKEY="mba_queue";
    function getQueue(){ try{ return JSON.parse(localStorage.getItem(QKEY)||"[]"); }catch(_){ return []; } }
    function setQueue(v){ localStorage.setItem(QKEY, JSON.stringify(v||[])); }
    function showQueue(){ const n=getQueue().length; document.getElementById('queue_info').textContent = n?`Hàng đợi chưa gửi: ${n}`:""; }
    async function flushQueue(){ if (!navigator.onLine) return; const q=getQueue(); if (!q.length) return; const keep=[]; for (const it of q){ try{ await apiPost(it.action, it.data); }catch(e){ keep.push(it); } } setQueue(keep); showQueue(); }

    /* Submit reading */
    document.getElementById('btn_submit').onclick = async ()=>{
      try{
        if (!st.pick) { alert("Chọn máy biến áp trước"); return; }
        const payload = {
          transformer_id: st.pick.id,
          V_kV: num('f_V'), I_A: num('f_I'), P_kW: num('f_P'),
          temp_C: num('f_temp'), oilTemp_C: num('f_oil'),
          tapPos: val('f_tap'), load_pct: num('f_load'),
          status: document.getElementById('f_status').value, note: val('f_note'),
          deviceId: navigator.userAgent.slice(0,120)
        };
        if (st.loc){ payload.lat=st.loc.lat; payload.lng=st.loc.lng; }
        const p64 = await fileToDataURL(document.getElementById('f_photo')); if (p64) payload.photoBase64=p64;
        if (!navigator.onLine){ enqueue_("add_reading", payload); alert("Đã lưu vào hàng đợi (offline)."); }
        else { await apiPost("add_reading", payload); alert("Đã lưu!"); }
        reset(['f_V','f_I','f_P','f_temp','f_oil','f_tap','f_load','f_note']); document.getElementById('f_photo').value="";
      }catch(e){ alert("Lỗi: "+e.message); }
    };
    function enqueue_(action, data){ const q=getQueue(); q.push({action, data}); setQueue(q); showQueue(); }
    function reset(ids){ ids.forEach(id=>document.getElementById(id).value=""); }
    function val(id){ return document.getElementById(id).value.trim(); }
    function num(id){ const v=val(id); return v?+v:""; }

    /* History */
    document.getElementById('btn_history').onclick = async ()=>{
      try{
        const id = val('h_id'), from = document.getElementById('h_from').value, to = document.getElementById('h_to').value;
        const data = await apiGet("history",{id,from,to,limit:200});
        const tb = document.querySelector('#hist_tbl tbody'); tb.innerHTML="";
        for (const r of data){
          const cls = r.status==="ALARM"?"bad":(r.status==="WARNING"?"warn":"ok");
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.tsISO||""}</td><td>${r.transformer_id||""}</td>
                          <td>${r.P_kW||""}</td><td>${r.temp_C||""}</td><td>${r.oilTemp_C||""}</td>
                          <td>${r.load_pct||""}</td><td class="${cls}">${r.status||""}</td><td>${(r.note||"").slice(0,120)}</td>`;
          tb.appendChild(tr);
        }
      }catch(e){ alert("Lỗi tải lịch sử: "+e.message); }
    };
    document.getElementById('btn_export').onclick = async ()=>{
      const id = val('h_id'), from = document.getElementById('h_from').value, to = document.getElementById('h_to').value;
      const url = BASE + "?" + new URLSearchParams({p:"api", fn:"export_history", id, from, to});
      const r = await fetch(url); const t = await r.text();
      const blob = new Blob([t], {type:"text/csv"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`history_${id||"all"}.csv`; a.click(); URL.revokeObjectURL(a.href);
    };

    /* Stats */
    let chart1, chart2;
    function ensureChart(){ return new Promise((res)=>{ if(window.Chart){res();return;} const s=document.createElement('script'); s.src="https://cdn.jsdelivr.net/npm/chart.js"; s.onload=()=>res(); document.body.appendChild(s); }); }
    async function drawCharts(d){
      await ensureChart();
      const ctx1 = document.getElementById('chart1').getContext('2d');
      const ctx2 = document.getElementById('chart2').getContext('2d');
      if (chart1) chart1.destroy(); if (chart2) chart2.destroy();
      chart1 = new Chart(ctx1, { type:'line', data:{ labels:d.series.ts, datasets:[ {label:'Temp (°C)', data:d.series.temp}, {label:'Oil (°C)', data:d.series.oilTemp} ] }, options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{x:{display:false}} }});
      chart2 = new Chart(ctx2, { type:'bar', data:{ labels:d.series.ts, datasets:[ {label:'Load %', data:d.series.load}, {label:'P kW', data:d.series.P_kW} ] }, options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{x:{display:false}} }});
    }
    document.getElementById('btn_stats').onclick = async ()=>{
      try{
        const id = val('s_id'), from=document.getElementById('s_from').value, to=document.getElementById('s_to').value;
        const d = await apiGet("stats",{id,from,to});
        setText("k_count",d.count); setText("k_avgT",d.avgTemp); setText("k_avgO",d.avgOilTemp); setText("k_avgL",d.avgLoadPct); setText("k_maxL",d.maxLoadPct);
        const ul=document.getElementById('anom'); ul.innerHTML=""; d.anomalies.forEach(a=>{ const li=document.createElement('li'); li.textContent=`${a.tsISO} — ${a.transformer_id} — T:${a.temp_C} Oil:${a.oilTemp_C} Load:${a.load_pct}% — ${a.status}`; ul.appendChild(li); });
        drawCharts(d);
      }catch(e){ alert("Lỗi thống kê: "+e.message); }
    };
    function setText(id,v){ document.getElementById(id).textContent=v; }

    /* SW */
    if ("serviceWorker" in navigator) { window.addEventListener("load", () => navigator.serviceWorker.register("sw.js")); }

    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    // Init
    (async function init(){
      try{
        st.me = await apiGet("me"); st.cfg = st.me.cfg||{}; setUser(st.me); guardRole(); showQueue();
        await reloadList();
      }catch(e){ console.warn("init:", e); }
    })();
  </script>
</body>
</html>
